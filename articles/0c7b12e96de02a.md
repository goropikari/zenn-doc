---
title: "Neovim: winbar ä¸Šã®ã‚¯ãƒªãƒƒã‚¯ã«åå¿œã•ã›ã‚‹"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["neovim"]
published: true
---


[Neovim v0.8](https://neovim.io/news/2022/12) ã§å…¥ã£ã¦ã„ãŸã¨ã„ã† winbar ã®å­˜åœ¨ã‚’ä»Šæ›´èªè­˜ã—ã€ã“ã‚Œã‚’ä½¿ãˆã°æœ€è¿‘èª²é¡Œæ„Ÿã‚’æ„Ÿã˜ã¦ã„ãŸ terminal buffer ã®åˆ‡ã‚Šæ›¿ãˆã‚’è‡ªåˆ†å¥½ã¿ã«ã§ããã†ã ã£ãŸã®ã§ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚

å‹•ä½œç¢ºèªã¯ Neovim v0.11.3 ã§è¡Œã„ã¾ã—ãŸã€‚

## winbar ã¨ã¯

window bar ã®ç•¥ã§å„ window ã®ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹éƒ¨åˆ†ã®ã“ã¨ã€‚
winbar å¤‰æ•°ã«ä½•ã‹ã—ã‚‰ã®å€¤ãŒè¨­å®šã•ã‚Œã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ãŸã¨ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã¨ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ãŒ winbar ã«è¡¨ç¤ºã•ã‚Œã¾ã™

```vim
lua vim.o.winbar = '%f'
```

![file](/images/neovim_winbar/file.png)

## ã‚¯ãƒªãƒƒã‚¯ã«åå¿œã•ã›ã‚‹

è¡¨ç¤ºã•ã›ãŸéƒ¨åˆ†ã¯ã‚¯ãƒªãƒƒã‚¯ã«åå¿œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¨ winbar ã« `[Hello]` ã¨è¡¨ç¤ºã•ã‚Œã€ãã®éƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ buffer ã«æ–‡å­—ãŒæŒ¿å…¥ã•ã‚Œã¾ã™

```lua:sample.lua
function _G.my_winbar_click_handler(id, clicks, button, mods)
 local comment = ("-- id: %s, num clicks %d,  (button: %s), mods %s"):format(id, clicks, button, mods)
 vim.api.nvim_buf_set_lines(0, -1, -1, false, { comment })
end

vim.o.winbar = "%123@v:lua.my_winbar_click_handler@[Hello]%T"
```

![click](/images/neovim_winbar/click.png)

`%{int}@v:lua.some_function@{display string}%T` ã®å½¢å¼ã§æ›¸ãã¨ã€`{display string}` ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã« `some_function` ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
é–¢æ•°ã¯4ã¤ã®å¼•æ•°ã‚’å–ã‚Šã€ç¬¬1å¼•æ•°ã«ã¯ `{int}` ã§æŒ‡å®šã—ãŸæ•´æ•°å€¤ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚ç¬¬2å¼•æ•°ã«ã¯ã‚¯ãƒªãƒƒã‚¯æ•°ã€ç¬¬3å¼•æ•°ã«ã¯ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®ç¨®é¡ (`l`, `r`, `m` ã®3ç¨®ã€‚ãã‚Œãã‚Œå·¦ã‚¯ãƒªãƒƒã‚¯ã€å³ã‚¯ãƒªãƒƒã‚¯ã€ä¸­ã‚¯ãƒªãƒƒã‚¯)ã€ç¬¬4å¼•æ•°ã«ã¯ä¿®é£¾ã‚­ãƒ¼(ctrl, alt, etc)ã®åå‰ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚
`%T` ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½é ˜åŸŸã®çµ‚ç«¯ã‚’è¡¨ã—ã¾ã™ã€‚`%T` ã®ä»£ã‚ã‚Šã« `%X` ã‚‚ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚
tabbar ç­‰ã§ã¯ `%X` ã¨ `%T` ã§é•ã„ãŒã‚ã‚‹ã‚ˆã†ã§ã™ãŒã€winbar ã«ãŠã„ã¦ã¯ä»Šã®ã¨ã“ã‚å·®ã¯ãªã„ã‚ˆã†ã«æ€ã„ã¾ã™ã€‚

### ref

- <https://github.com/neovim/neovim/blob/v0.11.3/runtime/doc/options.txt#L6072-L6097>
- <https://github.com/neovim/neovim/blob/v0.11.3/runtime/doc/options.txt#L6310-L6313>

## buffer ã®åˆ‡ã‚Šæ›¿ãˆ

ã‚‚ã†å°‘ã—å®Ÿç”¨çš„ãªä¾‹ã¨ã—ã¦ä»¥ä¸‹ã§ã¯ buffer ã®åˆ‡ã‚Šæ›¿ãˆã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ buffer number ãŒé–¢æ•°ã«æ¸¡ã‚‹ã‚ˆã†ã«ã—ã¦ `vim.api.nvim_set_current_buf` ã§ buffer ã®åˆ‡ã‚Šæ›¿ãˆã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

```lua:switch_buffer.lua
local bufnrs = {}
for i = 1, 5 do
  local bufnr = vim.api.nvim_create_buf(false, true)
  table.insert(bufnrs, bufnr)
  vim.api.nvim_buf_set_lines(bufnr, 0, -1, false, { 'Buffer ' .. bufnr })
end

local winid = vim.api.nvim_open_win(bufnrs[1], true, {
  split = 'below',
  height = math.floor(vim.o.lines * 0.4),
  style = 'minimal',
})

local function set_winbar(winid, bufnrs)
  local winbar_text_format = '%%%d@v:lua.my_winbar_click_handler@[Buffer %d]%%T'
  local winbar_text = ''
  for i, bufnr in ipairs(bufnrs) do
    winbar_text = winbar_text .. string.format(winbar_text_format, bufnr, bufnr)
    if i < #bufnrs then
      winbar_text = winbar_text .. ' | '
    end
  end

  vim.api.nvim_set_option_value('winbar', winbar_text, {
    win = winid,
  })
end

function _G.my_winbar_click_handler(minwid, clicks, button, mods)
  vim.api.nvim_set_current_buf(minwid)
  set_winbar(winid, bufnrs)
end

set_winbar(winid, bufnrs)
```

![switch buffer](/images/neovim_winbar/switch_buffer.gif)

ä¸Šè¨˜ã®ä¾‹ã¯æ™®é€šã® buffer ã§ã™ãŒã€ç§ã¯ã“ã‚Œã‚’ [toggleterm](https://github.com/akinsho/toggleterm.nvim) ã§ä½œã‚‰ã‚ŒãŸ terminal buffer ã®åˆ‡ã‚Šæ›¿ãˆã«ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ç´ ã® toggleterm ã§ã‚‚ HEAD ã§ã¯ winbar å¯¾å¿œã•ã‚Œã¦ã„ã¾ã™ãŒã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ–°ã—ã„ window ã§é–‹ãã¾ã™ã€‚ä¸€æ–¹ã€ç§ã®ä½¿ã„æ–¹ã¨ã—ã¦ã¯ window ãã®ã¾ã¾ã§ buffer ã®åˆ‡ã‚Šæ›¿ãˆã‚’è¡Œã„ãŸã‹ã£ãŸãŸã‚ã€toggleterm ã® custom terminal ã‚’ä½¿ã„ã¤ã¤ winbar ã§åˆ‡ã‚Šæ›¿ãˆãŒè¡Œãˆã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

![switch terminal buffer](/images/neovim_winbar/term_buffer.png)

<https://github.com/goropikari/tabterm.nvim>

ä¸Šè¨˜ã®ã‚ˆã†ã«ç‰¹å®šã®æ¡ä»¶ã‚’æº€ãŸã™ buffer ã‚’ winbar ã«è¡¨ç¤ºã—ã¦åˆ‡æ›¿å¯èƒ½ã«ã™ã‚‹ã¨ã„ã£ãŸç”¨é€”ã«ã¯çµæ§‹ä¾¿åˆ©ã ã¨æ€ã„ã¾ã—ãŸã€‚
