---
title: "ã‚³ãƒ³ãƒ†ãƒŠã« ssh ã§æ¥ç¶šã™ã‚‹éš›ã¡ã‚‡ã£ã¨ä¾¿åˆ©ã«ãªã‚‹ .ssh/config ã®æ›¸ãæ–¹"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["docker", "devcontainer","ssh"]
published: true
---

ã¨ãã«ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã« ssh ã§æ¥ç¶šã—ãŸã„ã¨ã„ã†ã¨ããŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ç§ã®å ´åˆã¯ devcontainer ã§ä½œã£ãŸé–‹ç™ºç’°å¢ƒã¸ ssh ã§å…¥ã£ã¦ã„ã‚‹ã®ã§æ¯æ—¥ä½¿ã£ã¦ã„ã¾ã™ã€‚

https://zenn.dev/goropikari/articles/nvim_devcontainer

ä¸€ã¤ã®ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦ ssh ã‚’ã™ã‚‹ãã‚‰ã„ãªã‚‰ã‚ˆã„ã§ã™ãŒã€è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦åŒæ™‚ã« ssh ã—ã‚ˆã†ã¨æ€ã†ã¨ port ãŒè¡çªã—ãªã„ã‚ˆã†ã« port forward ã®ã“ã¨ã‚’è€ƒãˆãªã‘ã‚Œã°ãªã‚‰ãšé¢å€’ã§ã™ã€‚
ãªã‚‰ã„ã£ã port forward ãªã‚“ã¦ã—ãªã‘ã‚Œã°ã„ã„ã‚ã‘ã§ã™ãŒã€ãã®æ™‚ `.ssh/config` ã‚’å·¥å¤«ã™ã‚‹ã¨é‹ç”¨ãŒæ¥½ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ 

# ã‚µãƒãƒª

- ç«‹ã¡ä¸Šã’ãŸã‚³ãƒ³ãƒ†ãƒŠã®åå‰ã‚’ rename or name æŒ‡å®šã§ç«‹ã¡ä¸Šã’ã‚‹
- ProxyCommand ã§ã‚³ãƒ³ãƒ†ãƒŠåã‹ã‚‰ IP ã‚’èª¿ã¹ã‚‹ã‚ˆã†ã«ã—ã¦ãŠã
- `ssh {container_name}` ã§æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹

`devc-` prefix ãŒã¤ã„ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦ ssh ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ config ä¾‹ã€‚(SSH ã® devcontainer feature ã§ã¯ 2222 port ã§æ¥ç¶šå¾…ã¡ã—ã¦ã„ã‚‹)

```ssh:~/.ssh/config
Host devc-*
    ProxyCommand /usr/bin/nc $(docker inspect %h --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}') %p
    Port 2222
    User vscode
```


# è©³ç´°
## å‹•ä½œç¢ºèªç’°å¢ƒ
- OS: Ubuntu 24.10
- docker: version 27.4.1
- devcontainer cli: version 0.72.0

## å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ã‚‹

ã‚³ãƒ³ãƒ†ãƒŠã‚’2ã¤èµ·å‹•ã—ã¦å®Ÿéš›ã«è©¦ã—ã¦ã¿ã¾ã™ã€‚

```bash
for d in devc-test1 devc-test2; do
    devcontainer templates apply --template-id ghcr.io/devcontainers/templates/ubuntu:1.3.2 --features='[{"id":"ghcr.io/devcontainers/features/sshd:1", "options":{}}]' --workspace-folder=$d
    res=$(devcontainer up --workspace-folder=$d)
    id=$(echo $res | jq -r .containerId)
    docker rename $id $d

    # ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã«å…¬é–‹éµã‚’é…ç½®
    devcontainer exec --workspace-folder=$d mkdir -p /home/vscode/.ssh
    docker cp ~/.ssh/id_ed25519.pub $d:/home/vscode/.ssh/authorized_keys
    devcontainer exec --workspace-folder=$d bash -c 'chmod 644 /home/vscode/.ssh/authorized_keys'
    devcontainer exec --workspace-folder=$d bash -c 'chmod 700 /home/vscode/.ssh'
done
```

```bash:~/.ssh/config
Host devc-*
    ProxyCommand /usr/bin/nc $(docker inspect %h --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}') %p
    Port 2222
    User vscode
```

ã“ã®çŠ¶æ…‹ã§ `ssh devc-test1` ã‚„ `ssh devc-test2` ã¨ã™ã‚‹ã¨ãã‚Œãã‚Œã®ã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## config ã«ä½•ã‚’æ›¸ã„ã¦ã„ã‚‹ã®ã‹

```bash:~/.ssh/config
Host devc-*
    ProxyCommand /usr/bin/nc $(docker inspect %h --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}') %p
    Port 2222
    User vscode
```

hostname ã«ã¯ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ãŒä½¿ãˆã€ã“ã®æ›¸ãæ–¹ã ã¨ `devc-` prefix ãŒã¤ã‘ã‚‰ã‚ŒãŸ hostname ã‚’æŒ‡å®šã™ã‚‹ã¨ã“ã®è¨­å®šãŒä½¿ã‚ã‚Œã¾ã™ã€‚

`%h`, `%p` ã¯ ssh_config ã§ä½¿ãˆã‚‹ TOKEN ã§ãã‚Œãã‚Œ hostname, port ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

docker container name ã¨ hostname ã‚’åˆã‚ã›ã¦ãŠã‘ã° `docker inspect %h --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'` ã«ã‚ˆã£ã¦æŒ‡å®šã—ãŸã‚³ãƒ³ãƒ†ãƒŠã® ip address ãŒå–å¾—ã§ãã¾ã™ã€‚

ProxyCommand ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã“ã¨ã‹ã‚‰æƒ³åƒã§ãã‚‹ã‚ˆã†ã« `nc` ã¯ Proxy ã®å½¹å‰²ã‚’ã—ã¦ã„ã¾ã™ã€‚SSH server ã¨ã¯ nc ã‚’ä»‹ã—ã¦é€šä¿¡ã—ã€client ã¨ nc é–“ã¯ stdin/stdout ã§é€šä¿¡ã•ã‚Œã¾ã™ã€‚

ä»¥ä¸Šã«ã‚ˆã‚Š localhost ã« port forward ã›ãšã¨ã‚‚æ¥½ã«ã‚³ãƒ³ãƒ†ãƒŠã« SSH ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
